<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>スクワットカウンター（返りの黄金バランス＋休憩）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #count { font-size: 48px; margin-bottom: 20px; }
    #ball {
      margin: 0 auto 20px auto;
      background-color: #ff6347;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      transition: width 0.3s ease, height 0.3s ease, background-color 0.1s ease;
    }
    #controls { margin-bottom: 20px; }
  </style>
</head>
<body>

  <h1>スクワット回数: <span id="count">0</span></h1>
  <div id="ball"></div>

  <div id="controls">
    <button id="startBtn">スタート</button>
    <button id="stopBtn">ストップ</button><br><br>

    <label>BPM:
      <select id="bpmSelect">
        <option value="35">35</option>
        <option value="45">45</option>
        <option value="60" selected>60</option>
        <option value="80">80</option>
        <option value="100">100</option>
        <option value="120">120</option>
      </select>
    </label><br><br>

    <label>タイムリミット（秒）:
      <select id="timeLimitSelect">
        <option value="30">30秒</option>
        <option value="60" selected>60秒</option>
        <option value="90">90秒</option>
      </select>
    </label><br><br>

    <label>セット数:
      <select id="setCountSelect">
        <script>
          for (let i = 1; i <= 20; i++) {
            document.write(`<option value="${i}">${i}セット</option>`);
          }
        </script>
      </select>
    </label>

    <div id="timerDisplay"></div>
    <div id="setDisplay"></div>
  </div>

  <script>
    let count = 0;
    let lastCountTime = 0;
    let direction = 'none';
    let running = false;
    let timerInterval = null;
    let beatIntervalId = null;
    let remainingTime = 60;
    let currentSet = 1;
    let totalSets = 1;
    let lastBeatTime = 0;

    const THRESHOLD_ANGLE = 20;
    const THRESHOLD_ACCEL = 0.8;
    const MIN_INTERVAL = 600;

    const countElem = document.getElementById('count');
    const ballElem = document.getElementById('ball');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const bpmSelect = document.getElementById('bpmSelect');
    const timeLimitSelect = document.getElementById('timeLimitSelect');
    const setCountSelect = document.getElementById('setCountSelect');
    const timerDisplay = document.getElementById('timerDisplay');
    const setDisplay = document.getElementById('setDisplay');

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function speak(text) {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ja-JP';
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      window.speechSynthesis.speak(utterance);
    }

    function handleSquatDetected() {
      const now = Date.now();
      if (now - lastCountTime < MIN_INTERVAL) return;
      lastCountTime = now;
      count++;
      countElem.textContent = count;
      updateBallSize();
      speak(count.toString());
      if (count % 10 === 0) specialSurprise();
    }

    function specialSurprise() {
      const phrases = ['ナイス！', 'すごい！', 'がんばってるね！', 'その調子！', 'イイ感じ！'];
      const phrase = phrases[Math.floor(Math.random() * phrases.length)];
      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      osc.type = 'triangle';
      osc.frequency.value = 1200;
      gainNode.gain.value = 0.3;
      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.3);
      speak(phrase);
    }

    function updateBallSize() {
      const minSize = 50, maxSize = 200;
      const size = Math.min(minSize + (maxSize - minSize) * (count / 100), maxSize);
      ballElem.style.width = size + 'px';
      ballElem.style.height = size + 'px';
    }

    function getBpmInterval() {
      return 60000 / parseInt(bpmSelect.value);
    }

    function playBeep() {
      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880;
      gainNode.gain.value = 0.2;
      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.1);
    }

    function playClick() {
      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.value = 1800;
      gainNode.gain.value = 0.1;
      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.05);
    }

    function flashBall() {
      ballElem.style.backgroundColor = '#ffa07a';
      setTimeout(() => ballElem.style.backgroundColor = '#ff6347', 150);
    }

    function startBeat() {
      const bpmInterval = getBpmInterval();
      lastBeatTime = Date.now();
      playBeep();
      flashBall();
      beatIntervalId = setInterval(() => {
        lastBeatTime = Date.now();
        playBeep();
        flashBall();
        if (Math.random() < 0.3) {
          setTimeout(playClick, bpmInterval / 2);
        }
      }, bpmInterval);
    }

    function startTimer() {
      remainingTime = parseInt(timeLimitSelect.value);
      timerDisplay.textContent = `残り: ${remainingTime}秒`;
      setDisplay.textContent = `セット: ${currentSet}/${totalSets}`;
      timerInterval = setInterval(() => {
        remainingTime--;
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          clearInterval(beatIntervalId);
          if (currentSet < totalSets) {
            startRest();
          } else {
            stopSession();
            speak("終了！");
          }
        } else if (remainingTime <= 5 || remainingTime % 5 === 0) {
          speak(`${remainingTime}秒`);
        }
        timerDisplay.textContent = `残り: ${remainingTime}秒`;
      }, 1000);
    }

    function startRest() {
      let restTime = 60;
      speak(`セット${currentSet}終了。休憩${restTime}秒`);
      timerDisplay.textContent = `休憩: ${restTime}秒`;
      setDisplay.textContent = `次はセット${currentSet + 1}/${totalSets}`;
      timerInterval = setInterval(() => {
        restTime--;
        if (restTime <= 0) {
          clearInterval(timerInterval);
          currentSet++;
          startSession(true);
        } else if (restTime <= 5 || restTime % 5 === 0) {
          speak(`${restTime}秒`);
        }
        timerDisplay.textContent = `休憩: ${restTime}秒`;
      }, 1000);
    }

    function stopSession() {
      running = false;
      clearInterval(timerInterval);
      clearInterval(beatIntervalId);
    }

    function startSession(isNextSet = false) {
      if (!isNextSet) {
        count = 0;
        countElem.textContent = count;
        currentSet = 1;
        totalSets = parseInt(setCountSelect.value);
        speak("スタート");
      } else {
        count = 0;
        countElem.textContent = count;
        speak(`セット${currentSet}開始`);
      }
      running = true;
      lastCountTime = 0;
      startTimer();
      startBeat();
    }

    window.addEventListener('devicemotion', (event) => {
      if (!running) return;
      const y = event.accelerationIncludingGravity.y;
      const z = event.accelerationIncludingGravity.z;
      const angle = Math.atan2(y, z) * (180 / Math.PI);
      const verticalAccel = Math.abs(z) > Math.abs(y) ? z : y;
      const now = Date.now();
      if (angle > THRESHOLD_ANGLE && verticalAccel > THRESHOLD_ACCEL && direction === 'none') {
        direction = 'down';
      } else if (angle < THRESHOLD_ANGLE && verticalAccel < -THRESHOLD_ACCEL && direction === 'down') {
        const bpmInterval = getBpmInterval();
        const timeSinceLastBeat = (now - lastBeatTime) % bpmInterval;
        if (timeSinceLastBeat < 100 || timeSinceLastBeat > bpmInterval - 100) {
          handleSquatDetected();
          direction = 'none';
        }
      }
    });

    startBtn.addEventListener('click', () => startSession(false));
    stopBtn.addEventListener('click', stopSession);
  </script>
</body>
</html>
