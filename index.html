<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>スクワットリズムゲーム</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 20px;
  }
  #beat-circle {
    margin: 40px auto;
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: #ccc;
    transition: background-color 0.1s ease;
  }
  #count {
    font-size: 48px;
    margin-top: 20px;
  }
  #status {
    margin-top: 10px;
    font-size: 18px;
    color: #666;
  }
</style>
</head>
<body>

<h1>スクワットリズムゲーム</h1>
<label>
  BPM:
  <input type="number" id="bpmInput" value="60" min="30" max="200" />
</label>
<button id="startBtn">スタート</button>
<button id="stopBtn" disabled>ストップ</button>

<div id="beat-circle"></div>
<div id="count">カウント: 0</div>
<div id="status">準備OK</div>

<script>
  let bpm = 60;
  let interval = 60000 / bpm; // ms per beat
  let beatTimer = null;
  let count = 0;
  let lastBeatTime = 0;
  let squatDetected = false;
  const beatCircle = document.getElementById('beat-circle');
  const countElem = document.getElementById('count');
  const statusElem = document.getElementById('status');
  const bpmInput = document.getElementById('bpmInput');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');

  // 音声ファイルを0~100まで用意してる想定。ない場合は代替音
  function playCountSound(count) {
    let audioFile = '';
    if (count <= 100) {
      audioFile = `${count}.mp3`; // 例: "1.mp3", "2.mp3"...
    } else {
      audioFile = 'ding.mp3';
    }
    const audio = new Audio(audioFile);
    audio.play().catch(e => console.warn('Audio再生失敗', e));
  }

  // ビートの点滅＆音
  function beat() {
    lastBeatTime = Date.now();
    // 光らせる（色を変える）
    beatCircle.style.backgroundColor = '#4caf50';
    setTimeout(() => {
      beatCircle.style.backgroundColor = '#ccc';
    }, 150);
    // ビート音を鳴らす（ここはシンプルにクリック音的な短い音）
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'square';
    o.frequency.value = 440;
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
    o.stop(audioCtx.currentTime + 0.1);
  }

  // スクワット検出設定
  const THRESHOLD = -2.5; // y軸加速度の閾値（調整可）
  const TIMING_ALLOWANCE = interval * 0.3; // ビート前後の許容時間（30%）

  function handleSquatDetected() {
    const now = Date.now();
    // ビートのタイミング内か？
    if (Math.abs(now - lastBeatTime) <= TIMING_ALLOWANCE) {
      if (!squatDetected) { // 連続カウント防止
        count++;
        countElem.textContent = `カウント: ${count}`;
        playCountSound(count);
        statusElem.textContent = '成功！リズムに合わせてスクワット！';
        squatDetected = true;
        setTimeout(() => {
          squatDetected = false;
          statusElem.textContent = 'リズムを待ってください';
        }, 500);
      }
    } else {
      statusElem.textContent = 'タイミングずれています';
      setTimeout(() => {
        statusElem.textContent = 'リズムを待ってください';
      }, 500);
    }
  }

  function startGame() {
    bpm = Number(bpmInput.value);
    if (bpm < 30 || bpm > 200) {
      alert('BPMは30〜200の間で指定してください');
      return;
    }
    interval = 60000 / bpm;
    count = 0;
    countElem.textContent = `カウント: 0`;
    statusElem.textContent = 'リズムを待ってください';

    // 最初のビートをすぐ鳴らす
    beat();

    // 以降BPMに合わせてビートを鳴らす
    beatTimer = setInterval(beat, interval);

    startBtn.disabled = true;
    stopBtn.disabled = false;
  }

  function stopGame() {
    clearInterval(beatTimer);
    beatTimer = null;
    beatCircle.style.backgroundColor = '#ccc';
    statusElem.textContent = 'ゲーム停止中';
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  // 加速度センサーイベント
  window.addEventListener('devicemotion', (event) => {
    const y = event.accelerationIncludingGravity.y;
    if (y < THRESHOLD) {
      handleSquatDetected();
    }
  });

  startBtn.addEventListener('click', startGame);
  stopBtn.addEventListener('click', stopGame);
</script>

</body>
</html>
