<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆè§’åº¦åˆ¤å®šï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #count { font-size: 48px; margin-bottom: 20px; }
    #log, #stats {
      margin-top: 20px;
      font-size: 14px;
      white-space: pre-line;
      max-height: 200px;
      overflow-y: scroll;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      text-align: left;
      max-width: 400px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1>ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆå›žæ•°: <span id="count">0</span></h1>
  <div id="stats"></div>
  <div id="log"></div>

  <script>
    let count = 0;
    let lastCountTime = 0;
    const MIN_INTERVAL = 800; // ãƒŸãƒªç§’
    const ANGLE_THRESHOLD = 40; // åº¦
    let prevY = null;
    let prevZ = null;

    const countElem = document.getElementById('count');
    const logElem = document.getElementById('log');
    const statsElem = document.getElementById('stats');

    function playCountSound(count) {
      const maxPreloaded = 100;
      let audioFile = '';

      if (count <= maxPreloaded) {
        audioFile = `count_audio/${count}.mp3`;
      } else {
        audioFile = 'ding.mp3';
      }

      const audio = new Audio(audioFile);
      audio.play().catch((e) => {
        console.warn('Audio playback failed:', e);
      });
    }

    function saveLogEntry() {
      const now = new Date();
      const entry = `${now.toLocaleString()} ã« 1å›žã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ`;
      const logs = JSON.parse(localStorage.getItem('squatLogs') || '[]');
      logs.push(entry);
      localStorage.setItem('squatLogs', JSON.stringify(logs));
      renderLogs();
    }

    function saveDailyCount() {
      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      const dailyCounts = JSON.parse(localStorage.getItem('dailySquatCounts') || '{}');
      dailyCounts[today] = (dailyCounts[today] || 0) + 1;
      localStorage.setItem('dailySquatCounts', JSON.stringify(dailyCounts));
      renderDailyStats();
    }

    function renderLogs() {
      const logs = JSON.parse(localStorage.getItem('squatLogs') || '[]');
      logElem.textContent = logs.slice().reverse().join('\n');
    }

    function renderDailyStats() {
      const dailyCounts = JSON.parse(localStorage.getItem('dailySquatCounts') || '{}');
      const entries = Object.entries(dailyCounts)
        .sort((a, b) => b[0].localeCompare(a[0]))
        .map(([date, total]) => `${date}: ${total} å›ž`)
        .join('\n');
      statsElem.textContent = `ðŸ“… æ—¥åˆ¥ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆè¨˜éŒ²ï¼š\n${entries}`;
    }

    function handleSquatDetected() {
      const now = Date.now();
      if (now - lastCountTime > MIN_INTERVAL) {
        count++;
        countElem.textContent = count;
        playCountSound(count);
        saveLogEntry();
        saveDailyCount();
        lastCountTime = now;
      }
    }

    // æ”¹è‰¯ã•ã‚ŒãŸã‚¹ã‚¯ãƒ¯ãƒƒãƒˆåˆ¤å®šï¼ˆY-Zè§’åº¦ã®å¤‰åŒ–ãƒ™ãƒ¼ã‚¹ï¼‰
    window.addEventListener('devicemotion', (event) => {
      const acc = event.accelerationIncludingGravity;
      const y = acc.y;
      const z = acc.z;

      if (prevY === null || prevZ === null) {
        prevY = y;
        prevZ = z;
        return;
      }

      const prevAngle = Math.atan2(prevY, prevZ) * (180 / Math.PI);
      const currentAngle = Math.atan2(y, z) * (180 / Math.PI);
      const angleDiff = Math.abs(currentAngle - prevAngle);

      if (angleDiff > ANGLE_THRESHOLD) {
        handleSquatDetected();
      }

      prevY = y;
      prevZ = z;
    });

    window.onload = () => {
      renderLogs();
      renderDailyStats();
    };
  </script>
</body>
</html>
