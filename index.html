<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>スクワットカウンター</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #count { font-size: 48px; }
    #log {
      margin-top: 20px;
      font-size: 14px;
      white-space: pre-line;
      max-height: 300px;
      overflow-y: scroll;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
  </style>
</head>
<body>
  <h1>スクワット回数: <span id="count">0</span></h1>
  <div id="log"></div>

  <script>
    let count = 0;
    let lastCountTime = 0;
    const THRESHOLD = 2.5;
    const MIN_INTERVAL = 800; // ms

    const countElem = document.getElementById('count');
    const logElem = document.getElementById('log');

    // 合成済み音声ファイルを再生
    function playCountSound(count) {
      const maxPreloaded = 100;
      let audioFile = '';

      if (count <= maxPreloaded) {
        audioFile = `${count}.mp3`;
      } else {
        audioFile = 'ding.mp3'; // 100超えたら効果音
      }

      const audio = new Audio(audioFile);
      audio.play().catch((e) => {
        console.warn('Audio playback failed:', e);
      });
    }

    function saveLogEntry() {
      const now = new Date();
      const entry = `${now.toLocaleString()} に 1回スクワット`;
      const logs = JSON.parse(localStorage.getItem('squatLogs') || '[]');
      logs.push(entry);
      localStorage.setItem('squatLogs', JSON.stringify(logs));
      renderLogs();
    }

    function renderLogs() {
      const logs = JSON.parse(localStorage.getItem('squatLogs') || '[]');
      logElem.textContent = logs.slice().reverse().join('\n');
    }

    function handleSquatDetected() {
      const now = Date.now();
      if (now - lastCountTime > MIN_INTERVAL) {
        count++;
        countElem.textContent = count;
        playCountSound(count);
        saveLogEntry();
        lastCountTime = now;
      }
    }

    window.addEventListener('devicemotion', (event) => {
      const y = event.accelerationIncludingGravity.y;
      if (y < -THRESHOLD) {
        handleSquatDetected();
      }
    });

    window.onload = () => {
      renderLogs();
    };
  </script>
</body>
</html>
