<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>スクワットカウンター（モード切替＋音声＋波形）</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    canvas { border: 1px solid #ccc; display: block; margin: 20px auto; }
    label { font-weight: bold; }
  </style>
</head>
<body>
  <h1>スクワット回数: <span id="count">0</span></h1>

  <label>モード切替:
    <select id="mode">
      <option value="pocket">ポケットモード（y軸傾き）</option>
      <option value="handheld">手持ちモード（加速度）</option>
    </select>
  </label><br><br>

  <label>感度（しきい値）: <span id="thresholdValue">2.5</span>
    <input type="range" id="threshold" min="1" max="5" step="0.1" value="2.5" />
  </label>

  <canvas id="graph" width="500" height="200"></canvas>

  <script>
    let count = 0;
    let direction = 'none';
    let lastY = 0;
    let lastTime = 0;
    let directionLockTime = 0;
    const ctx = document.getElementById("graph").getContext("2d");
    let accelHistory = [];

    const thresholdInput = document.getElementById("threshold");
    const thresholdValue = document.getElementById("thresholdValue");
    const modeSelect = document.getElementById("mode");

    let THRESHOLD = parseFloat(thresholdInput.value);

    thresholdInput.addEventListener("input", () => {
      THRESHOLD = parseFloat(thresholdInput.value);
      thresholdValue.textContent = THRESHOLD;
    });

    function speak(text) {
      window.speechSynthesis.cancel(); // 読み上げが被らないように
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ja-JP";
      utterance.rate = 1.0;
      utterance.pitch = 1.1;
      window.speechSynthesis.speak(utterance);
    }

    if (window.DeviceMotionEvent) {
      window.addEventListener("devicemotion", function(event) {
        const x = event.accelerationIncludingGravity.x || 0;
        const y = event.accelerationIncludingGravity.y || 0;
        const z = event.accelerationIncludingGravity.z || 0;

        const magnitude = Math.sqrt(x * x + y * y + z * z);
        accelHistory.push(magnitude);
        if (accelHistory.length > 100) accelHistory.shift();

        const now = Date.now();
        const mode = modeSelect.value;

        // ----- 判定ロジック -----
        if (mode === "handheld") {
          const delta = magnitude - 9.8;

          if (delta < -THRESHOLD && direction === 'none') {
            direction = 'down';
            directionLockTime = now;
          }

          if (delta > THRESHOLD && direction === 'down') {
            if (now - directionLockTime > 300) {
              count++;
              document.getElementById("count").textContent = count;
              speak(count.toString());
              direction = 'none';
            }
          }
        } else if (mode === "pocket") {
          const deltaY = Math.abs(y - lastY);
          lastY = y;

          if (y < -THRESHOLD && direction === 'none') {
            direction = 'down';
            directionLockTime = now;
          }

          if (y > THRESHOLD && direction === 'down') {
            if (deltaY > 1 && now - directionLockTime > 300) {
              count++;
              document.getElementById("count").textContent = count;
              speak(count.toString());
              direction = 'none';
            }
          }
        }

        // ----- グラフ描画 -----
        ctx.clearRect(0, 0, 500, 200);
        ctx.beginPath();
        accelHistory.forEach((val, i) => {
          const yPos = 200 - val * 10;
          ctx.lineTo(i * 5, yPos);
        });
        ctx.stroke();

        // しきい値ライン
        ctx.beginPath();
        ctx.strokeStyle = 'red';
        const threshLine = 200 - (9.8 + THRESHOLD) * 10;
        ctx.moveTo(0, threshLine);
        ctx.lineTo(500, threshLine);
        ctx.stroke();
        ctx.strokeStyle = 'black';
      }, true);
    } else {
      alert("この端末は加速度センサーに対応していません。");
    }
  </script>
</body>
</html>
